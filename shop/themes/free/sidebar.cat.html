{strip}
{$category_selected=null}
{$categories_open = []}
{if isset($category)}
    {$category_selected=$category.id}
{elseif isset($product)}
    {$category_selected=$product.category_id}
{/if}

{if $category_selected}
    {$categories_open[] = $root_category_id}
    {if isset($category) && $category.parent_id > 0 &&  $category.parent_id != $root_category_id}
        {$categories_open[] = $category.parent_id}
    {/if}
{/if}

{$categories = []}
{if $theme_settings.sb_cat_content == 'app-menu' && $wa->menu && (int)$theme_settings.sb_cat_app_menu_id > 0}
    {$id_menu = $theme_settings.sb_cat_app_menu_id}
    {$categories = $wa->menu->get($id_menu)}
{else if $theme_settings.sb_cat_content == 'catalog'}
    {$categories = $wa->shop->categories(0, null, true, true)}

    {if class_exists('shopWmimageincatPlugin')}
        {$Wmimages = shopWmimageincatPlugin::getCategoryImageObj()}
    {/if}
{/if}

{function name=getSubcategories subcategories=[] parent=[]}
    {if count($subcategories) > 0}
        <ul class="sidebar-subcategories{if $category_selected != $parent.id && !in_array($parent.id, $categories_open) && !isset($parent.params.sidebar_open)} hide{/if} js-subcat">
            {foreach $subcategories as $key => $subcat}
                {if !isset($subcat.params.menu_hide)}
                    {$_has_childs = false}
                    {if !empty($subcat.childs)}
                        {foreach $subcat.childs as $child}
                            {if !isset($child.params.menu_hide)}
                                {$_has_childs = true}
                            {/if}
                        {/foreach}
                    {/if}
                    <li class="sidebar-subcategories_el{if $category_selected == $subcat.id} selected{/if}"{if $category_selected == $subcat.id} data-is-open="1"{/if}>
                        <a href="{$subcat.url}">{$subcat.name}</a>
                        {if $_has_childs}{getSubcategories subcategories=$subcat.childs parent=$subcat}{/if}
                    </li>
                {/if}
            {/foreach}
        </ul>
    {/if}
{/function}

{if !empty($categories)}
    <div class="sb-wrap sidebar-categories">
        <ul class="js-sidebar-cats sidebar-cats" data-lazy="{$theme_settings.categories_menu_images_lazy}">
            {foreach $categories as $category}
                {$_has_childs = false}
                {if !empty($category.childs)}
                    {foreach $category.childs as $child}
                        {if !isset($child.params.menu_hide)}
                            {$_has_childs = true}
                        {/if}
                    {/foreach}
                {/if}

                {if !isset($category.params.menu_hide)}
                    <li class="sidebar-cats_el{if $categoryegory_selected == $category.id} selected{/if}">
                        {if $_has_childs}<i class="sidebar-cats_el-open fi-rr-angle-small-down sdColor js-subcat-open{if $category_selected == $category.id  || isset($category.params.sidebar_open)} selected{/if}"></i>{/if}
                        <a class="sidebar-cats_link" href="{$category.url}">
                            {if $theme_settings.icon_sidebar_subcategories}
                                {if isset($Wmimages[$category.id].icon) && !isset($category.page)}
                                    {$category.params.icon = $Wmimages[$category.id].icon}
                                {/if}
                                {if isset($skImages[$category.id].icon) && !isset($category.page)}
                                    {$category.params.icon = $skImages[$category.id].icon}
                                {/if}
                                {if isset($category.params.icon)}
                                    <div class="sidebar-cats_icon">
                                        {if $theme_settings.categories_menu_images_lazy}
                                            <img class="js-sidebar-cat-image" src="{$wa_theme_url}img/lazy-image.png" alt="{$category.name}" data-src="{$category.params.icon}" />
                                        {else}
                                            <img class="js-sidebar-cat-image" alt="{$category.name}" src="{$category.params.icon}" />
                                        {/if}
                                    </div>
                                {/if}
                            {/if}
                            <div class="sidebar-cats_title">
                                {$category.name}
                            </div>
                        </a>
                        {if $_has_childs}{getSubcategories subcategories=$category.childs parent=$category}{/if}
                    </li>
                {/if}
            {/foreach}
        </ul>
    </div>
{/if}
{/strip}
