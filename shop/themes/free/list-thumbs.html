{strip}
    {if !isset($isViewSwitch)}{$isViewSwitch = 0}{/if}
    {if !isset($ulclass)}{$ulclass = ''}{/if}
    {if !isset($_not_paginate)}{$_not_paginate = 0}{/if}

    <!-- products thumbnail list view -->
    {if !isset($CategoryViewProducts) || empty($CategoryViewProducts)}
        {$CategoryViewProducts = 'tile'}
    {/if}
    {$views_count = 0}
    {$_isView_tile = false}
    {$_isView_list = false}
    {$_isView_tbl = false}

    {if $isViewSwitch}
        {if !empty($theme_settings.product_preview_tile)}
            {$views_count = $views_count+1}
            {$_isView_tile = true}
        {/if}
        {if !empty($theme_settings.product_preview_list)}
            {$views_count = $views_count+1}
            {$_isView_list = true}
        {/if}
        {if !empty($theme_settings.product_preview_table)}
            {$views_count = $views_count+1}
            {$_isView_tbl = true}
        {/if}
        {$CategoryViewProducts = $theme_settings.pr_prev_type_default}

        {$cookieProductView = $wa->cookie('CategoryViewProducts')}
        {if ($cookieProductView == 'tile' && $_isView_tile)
        || ($cookieProductView == 'tbl' && $_isView_tbl)
        || ($cookieProductView == 'list' && $_isView_list)}
            {$CategoryViewProducts = $wa->cookie('CategoryViewProducts')}
        {/if}
    {/if}

    {* selected filters *}
    {if $theme_settings.filter_selected}{include file="category.select-filters.html"}{/if}

    {if !empty($sorting) || ($isViewSwitch &&  $views_count > 1)}
        <div class="cat-panel">
            <div class="df-block">
                {if $theme_settings.pagination != 'lazyloading'  && empty($_not_paginate) && !$wa->isMobile()}
                    <div class="cat-onpage">
                        <span class="cat-onpage-title">[`Display`]:</span>
                        <select id="set-per-page" class="cat-onpage_select">
                            {$current_per_page = $wa->cookie('products_per_page')}
                            {foreach [24,48,64] as $count}
                                <option{if $current_per_page == $count} selected{/if} value="{$count}">{$count}</option>
                            {/foreach}
                        </select>
                    </div>
                {/if}

                {if !empty($sorting)}
                    <!-- sorting -->
                    {$sort_fields = [
                    'name' => '[`Name`]',
                    'price' => '[`Price`]',
                    'total_sales' => '[`Bestsellers`]',
                    'rating' => '[`Customer rating`]',
                    'create_datetime'=>'[`Date added`]',
                    'stock' => '[`In stock`]']}
                    {if !isset($sort_active)}
                        {$sort_active = $wa->get('sort', 'create_datetime')}
                    {/if}

                    {$default_sort = false}
                    {if isset($category.sort_products) && !empty($category.sort_products)}
                        {$default_sort = " "|explode:$category.sort_products}
                    {/if}
                    <div class="cat-sort">
                        <div class="checked-list js-selecList cat-sort_select">
                            <div class="js-checked-toggle checked-list_toggle">
                                {if !$sort_active || !isset($sort_fields[$sort_active])}
                                    <a href="{$wa->currentUrl(0, 1)}">[`New & Popular`]</a>
                                {else}
                                    {foreach $sort_fields as $sort => $name}
                                        {if $sort_active == $sort}
                                            {if class_exists('shopSeofilterViewHelper')}
                                                {shopSeofilterViewHelper::sortUrl($sort, $name, $sort_active)}
                                            {else}
                                                {$wa->shop->sortUrl($sort, $name, $sort_active)}
                                            {/if}
                                        {/if}
                                    {/foreach}
                                {/if}
                                <div class="jq-checked__arrow-trigger">
                                    <i class=" icon fi-rr-caret-down"></i>
                                </div>
                            </div>
                            <ul class="js-select-items checked-list__items">
                                {if !empty($category) && !isset($sort_fields[$default_sort[0]])}
                                    <li{if !$sort_active} class="selected"{/if}><a href="{$wa->currentUrl(0, 1)}">[`New
                                            & Popular`]</a></li>
                                {/if}
                                {foreach $sort_fields as $sort => $name}
                                    <li{if $sort_active == $sort} class="selected"{/if}>
                                        {if class_exists('shopSeofilterViewHelper')}
                                            {shopSeofilterViewHelper::sortUrl($sort, $name, $sort_active)}
                                        {else}
                                            {$wa->shop->sortUrl($sort, $name, $sort_active)}
                                        {/if}
                                    </li>
                                    {if $wa->get('sort') == $sort}{$wa->title( $wa->title()|cat:' — '|cat:$name)}{/if}
                                {/foreach}
                            </ul>
                        </div>
                    </div>
                {/if}

                {if $views_count > 1}
                    <div class="cat-views">
                        {if $_isView_tile == true}
                            <i data-view="tile"
                               class="js-switch-product-view cat-views__el {if $CategoryViewProducts == 'tile'} selected{/if}"
                               aria-hidden="true">
                                {literal}
                                    <svg version="1.1" id="svgViewList" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                         viewBox="0 0 974.9 971.2" style="enable-background:new 0 0 974.9 971.2;" xml:space="preserve">
                                        <style type="text/css">
                                            #svgViewList .st1-0{fill:#E8E8E8;stroke:#E8E8E8;stroke-linejoin:round;stroke-miterlimit:10;}
                                            #svgViewList:hover .st1-0{fill:#000;stroke:#000;stroke-linejoin:round;stroke-miterlimit:10;}
                                            .selected #svgViewList .st1-0{fill:#000;stroke:#000;stroke-linejoin:round;stroke-miterlimit:10;}
                                            #svgViewList .st1-1{fill:#E8E8E8;stroke:#E8E8E8;stroke-linecap:round;stroke-linejoin:round;stroke-miterlimit:10;}
                                            #svgViewList:hover .st1-1{fill:#000;stroke:#000;stroke-linejoin:round;stroke-miterlimit:10;}
                                            .selected #svgViewList .st1-1{fill:#000;stroke:#000;stroke-linejoin:round;stroke-miterlimit:10;}
                                            #svgViewList .st1-2{fill:#E8E8E8;stroke:#E8E8E8;stroke-miterlimit:10;}
                                            #svgViewList:hover .st1-2{fill:#000;stroke:#000;stroke-linejoin:round;stroke-miterlimit:10;}
                                            .selected #svgViewList .st1-2{fill:#000;stroke:#000;stroke-linejoin:round;stroke-miterlimit:10;}
                                        </style>
                                        <path class="st1-0" d="M377.8,428.7H51.4c-28.1,0-50.9-22.8-50.9-50.9V51.4c0-28.1,22.8-50.9,50.9-50.9h326.4
                                            c28.1,0,50.9,22.8,50.9,50.9v326.4C428.7,405.9,405.9,428.7,377.8,428.7z"/>
                                        <path class="st1-1" d="M924.9,428.7H595.8c-27.4,0-49.5-22.2-49.5-49.5V50c0-27.4,22.2-49.5,49.5-49.5h329.1
                                            c27.4,0,49.5,22.2,49.5,49.5v329.1C974.4,406.5,952.3,428.7,924.9,428.7z"/>
                                        <path class="st1-2" d="M924.7,970.7H595.9c-27.5,0-49.7-22.3-49.7-49.7V592.1c0-27.5,22.3-49.7,49.7-49.7h328.8
                                            c27.5,0,49.7,22.3,49.7,49.7v328.8C974.4,948.4,952.2,970.7,924.7,970.7z"/>
                                        <path class="st1-2" d="M379.1,970.7h-329c-27.4,0-49.6-22.2-49.6-49.6V592c0-27.4,22.2-49.6,49.6-49.6h329c27.4,0,49.6,22.2,49.6,49.6
                                            v329C428.7,948.4,406.5,970.7,379.1,970.7z"/>
                                    </svg>
                                {/literal}
                            </i>
                        {/if}
                        {if $_isView_list == true}
                            <i data-view="list"
                               class="js-switch-product-view cat-views__el {if $CategoryViewProducts == 'list'} selected{/if}"
                               aria-hidden="true">
                                {literal}
                                    <svg version="1.1" id="svgViewList" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                         viewBox="0 0 988.5 991.3" style="enable-background:new 0 0 988.5 991.3;" xml:space="preserve">
                                        <style type="text/css">
                                            #svgViewList .st2-0{fill:#E8E8E8;stroke:#E8E8E8;stroke-miterlimit:0;}
                                            #svgViewList:hover .st2-0{fill:#000;stroke:#000;stroke-miterlimit:0;}
                                            .selected #svgViewList .st2-0{fill:#000;stroke:#000;stroke-miterlimit:0;}
                                        </style>
                                                                            <path class="st2-0" d="M168.4,218H50.2c-27.4,0-49.7-22.2-49.7-49.7V50.2c0-27.4,22.2-49.7,49.7-49.7h118.2
                                            c27.4,0,49.7,22.2,49.7,49.7v118.2C218,195.8,195.8,218,168.4,218z"/>
                                                                            <path class="st2-0" d="M168.4,606.8H50.1c-27.4,0-49.6-22.2-49.6-49.6V438.9c0-27.4,22.2-49.6,49.6-49.6h118.4
                                            c27.4,0,49.6,22.2,49.6,49.6v118.4C218,584.7,195.8,606.8,168.4,606.8z"/>
                                                                            <path class="st2-0" d="M169,990.8H49.5c-27.1,0-49-22-49-49V822.4c0-27.1,22-49,49-49H169c27.1,0,49,22,49,49v119.4
                                            C218,968.9,196.1,990.8,169,990.8z"/>
                                                                            <path class="st2-0" d="M938.4,218H380.2c-27.4,0-49.6-22.2-49.6-49.6V50.1c0-27.4,22.2-49.6,49.6-49.6h558.2
                                            c27.4,0,49.6,22.2,49.6,49.6v118.4C988,195.8,965.8,218,938.4,218z"/>
                                                                            <path class="st2-0" d="M938.5,606.8H380.1c-27.3,0-49.5-22.2-49.5-49.5V438.8c0-27.3,22.1-49.5,49.5-49.5h558.4
                                            c27.3,0,49.5,22.1,49.5,49.5v118.6C988,584.7,965.8,606.8,938.5,606.8z"/>
                                                                            <path class="st2-0" d="M938.4,990.8H380.1c-27.4,0-49.5-22.2-49.5-49.5V822.9c0-27.3,22.2-49.5,49.5-49.5h558.3
                                            c27.3,0,49.5,22.2,49.5,49.5v118.5C988,968.7,965.8,990.8,938.4,990.8z"/>
                                    </svg>
                                {/literal}
                            </i>
                        {/if}
                        {if $_isView_tbl == true}
                            <i data-view="tbl"
                               class="js-switch-product-view cat-views__el {if $CategoryViewProducts == 'tbl'} selected{/if}"
                               aria-hidden="true">
                                {literal}
                                    <svg version="1.1" id="svgViewList" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px"
                                         viewBox="0 0 769.4 769.4" style="enable-background:new 0 0 769.4 769.4;" xml:space="preserve">
                                        <style type="text/css">
                                            #svgViewList .st3-0{fill:#E8E8E8;}
                                            #svgViewList:hover .st3-0{fill:#000;}
                                            .selected #svgViewList .st3-0{fill:#000;}
                                        </style>
                                                                            <path class="st3-0" d="M732.4,108.8H37.1C16.3,108.8-0.5,87-0.5,60.1V48.8C-0.5,21.8,16.3,0,37.1,0h695.3C753.1,0,770,21.8,770,48.8
                                            v11.3C769.9,87,753.1,108.8,732.4,108.8z"/>
                                                                            <path class="st3-0" d="M732.3,329H37.2c-20.8,0-37.7-21.9-37.7-48.9V269c0-27,16.9-48.9,37.7-48.9h695.1c20.8,0,37.7,21.9,37.7,48.9
                                            v11.1C769.9,307.1,753.1,329,732.3,329z"/>
                                                                            <path class="st3-0" d="M732.6,549.2H36.8c-20.6,0-37.3-21.7-37.3-48.4v-12c0-26.8,16.7-48.4,37.3-48.4h695.8
                                            c20.6,0,37.3,21.7,37.3,48.4v12C769.9,527.5,753.2,549.2,732.6,549.2z"/>
                                                                            <path class="st3-0" d="M732.1,769.4H37.3c-20.9,0-37.8-22-37.8-49.1v-10.6c0-27.1,16.9-49.1,37.8-49.1H732c20.9,0,37.8,22,37.8,49.1
                                            v10.6C769.9,747.4,753,769.4,732.1,769.4z"/>
                                    </svg>
                                {/literal}
                                <style>
                                    #svgViewList {
                                        width: 18px;
                                    }
                                </style>
                            </i>
                        {/if}
                    </div>
                {/if}
            </div>
        </div>
    {/if}

    {if $wa->shop->cart->total() > 0}{$add2label_cart = '[`Add to cart`]'}{else}{$add2label_cart = '[`Buy`]'}{/if}
    {if !isset($isCategoryViewProductsList)}{$isCategoryViewProductsList = 0}{/if}

    {$isPreviewProductGalleryTile = (($theme_settings.product_scroll_hover_gallery && $CategoryViewProducts == 'tile') || ($theme_settings.preview_product_list_gallerytile && $CategoryViewProducts == 'list')) && $products}

    {if $isPreviewProductGalleryTile}
        {$products_ids = ""}
        {foreach $products as $p}
            {if $p.id}{$products_ids[] = $p.id}{/if}
        {/foreach}
        {$size_image = '0x260'} {if $CategoryViewProducts == 'list'}{$size_image = '180'}{/if}
        {$products_images = $wa->shop->images($products_ids, $size_image)}
    {/if}
    <div class="products-{$CategoryViewProducts}-outer">
        <div data-image-lazy="{$theme_settings.product_preview_images_lazy}"
             class="js-preview-products products-{$CategoryViewProducts} {if !empty($ulclass)} {$ulclass}{/if}"{if isset($attr)} {$attr}{/if}>
            {$features = []}
            {$_features_product_list = !empty($theme_settings.product_show_list_features) && $CategoryViewProducts == 'list'}
            {if !$wa->isMobile()}
                {$_features_product_tile = !empty($theme_settings.product_show_tile_features) && $CategoryViewProducts == 'tile'}
            {else}
                {$_features_product_tile = !empty($theme_settings.product_show_tile_mobile_features) && $CategoryViewProducts == 'tile'}
            {/if}

            {if $_features_product_list || $_features_product_tile}
                {$features = $wa->shop->features($products)}
            {/if}

            {$favorites = $wa->cookie('product_favor_arr')}
            {if $favorites}
                {$product_favor_arr = ","|explode:$favorites}
            {else}
                {$product_favor_arr = []}
            {/if}

            {if ($theme_settings.show_grid_sku && $CategoryViewProducts == 'tile')
            || ($theme_settings.show_sku_list && $CategoryViewProducts == 'list')
            || ($theme_settings.show_sku_product-tbl && $CategoryViewProducts == 'tbl')}
                {$all_skus = $wa->shop->skus(array_keys($products))}
            {/if}

            <script>
                if (typeof(imgObjProducts) != "undefined" && imgObjProducts !== null) {
                    let imgObjProducts = new Object();
                }
            </script>
            {foreach $products as $p}
                {if isset($all_skus) && !empty($all_skus) && isset($all_skus[$p.id])}
                    {$skus = $all_skus[$p.id]}
                    {$p.skus_list = reset($skus)}
                {/if}

                {if $CategoryViewProducts == 'list'}
                    {include file="product-preview-line.html" product=$p features=$features favorites=$product_favor_arr}
                {else if $CategoryViewProducts == 'tbl'}
                    {include file="product-preview-tbl.html" product=$p favorites=$product_favor_arr}
                {else}
                    {include file="product-preview-tile.html" product=$p favorites=$product_favor_arr}
                {/if}
            {/foreach}

            {if $isPreviewProductGalleryTile}
                <script>
                    $(function () {
                        new productGridGallery();
                    });
                </script>
            {/if}
        </div>
    </div>
    <div class="{if $theme_settings.pagination == 'lazyloading'}lazy-paging{else}category-pag-offset{/if}"
         data-times="2" data-link-text="[`Load more`]" data-loading-str="[`Loading...`]">
        {if isset($pages_count) && $pages_count > 1  && !$_not_paginate}
            {if class_exists('shopSeofilterViewHelper')}
                {capture assign=pagination}
                    {wa_pagination total=$pages_count attrs=['class' => "pagination"]}
                {/capture}
                {shopSeofilterViewHelper::paginationDecorate($pagination)}
            {else}
                {wa_pagination total=$pages_count attrs=['class' => "pagination"]}
            {/if}
        {/if}
    </div>
{/strip}

{if !$wa->isMobile()}
    <style>
        .grid-gallery__list {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            display: -ms-flexbox;
            display: flex;
        }
        span.grid-gallery__el.js-grid-gallery-item {
            z-index: 2;
        }
        ._tile-active .grid-gallery__el {
            position: relative;
        }
    </style>
    <script>
        $(function () {
            $(".grid-gallery__el").hover(function() {
                let _this = $(this);
                let id = _this.attr('data-id')
                let wrap = _this.closest('.Product-grid');
                wrap.find('.dotted-img__item').each(function() {
                    if ($(this).attr('data-id') == id) {
                        $(this).addClass('-Active');
                    } else {
                        $(this).removeClass('-Active');
                    }
                });
            });
            $('.Product-grid_img').mouseout(function() {
                $('.dotted-img__item').each(function() {
                    if ($(this).attr('data-id') == 1) {
                        $(this).addClass('-Active');
                    } else {
                        $(this).removeClass('-Active');
                    }
                });
            })
        })
    </script>
{else}
    <script>
        var startCoords = {},
            endCoords = {};
        let productId = '';
        let product = '';

        $('.Product-grid_img').bind("touchstart", function(event) {
            startCoords = endCoords = event.originalEvent.targetTouches[0];
            product = $(this).closest('.Product-grid');
            productId = product.attr("data-product-id");
        });
        $('.Product-grid_img').bind("touchmove", function(event) {
            endCoords = event.originalEvent.targetTouches[0];
        });
        {literal}
            $('.Product-grid_img').bind("touchend", function() {
                let mobileProductWrapDotted = product.find('.dotted-img__item');
                let startSrc = $(this).find('.js-product-preview-img').attr("src");
                imgObjProducts[productId].forEach((element, index) => {
                    if (startSrc == element) {
                        startSrcIndex = index;
                        if (startCoords.clientX < endCoords.clientX){ // назад
                            endSrcIndex = startSrcIndex - 1;
                            $(this).find('.js-product-preview-img').attr("src", imgObjProducts[productId][endSrcIndex]);
                            mobileProductWrapDotted.each(function() {
                                if (endSrcIndex >= 0) {
                                    if ($(this).attr('data-id') == endSrcIndex + 1) {
                                        $(this).addClass('-Active');
                                    } else {
                                        $(this).removeClass('-Active');
                                    }
                                }
                            });
                        }
                        if (startCoords.clientX > endCoords.clientX){ // след
                            endSrcIndex = startSrcIndex + 1;
                            $(this).find('.js-product-preview-img').attr("src", imgObjProducts[productId][endSrcIndex]);
                            mobileProductWrapDotted.each(function() {
                                if (endSrcIndex < mobileProductWrapDotted.length) {
                                    if ($(this).attr('data-id') == endSrcIndex + 1) {
                                        $(this).addClass('-Active');
                                    } else {
                                        $(this).removeClass('-Active');
                                    }
                                }
                            });
                        }
                    }
                })
            });
        {/literal}
    </script>
{/if}
