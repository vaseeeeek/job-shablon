{strip}

{if !empty($theme_settings.text_product_not_available)}
    {$text_not_avalible = $theme_settings.text_product_not_available}
{else}
    {$text_not_avalible = "[`Out of stock`]"}
{/if}
{if !empty($theme_settings.text_product_preorder)}
    {$text_product_preorder = $theme_settings.text_product_preorder}
{else}
    {$text_product_preorder = "[`Pre-order only`]"}
{/if}
{if !empty($theme_settings.text_product_not_available_option)}
    {$text_product_not_available_option = $theme_settings.text_product_not_available_option}
{else}
    {$text_product_not_available_option = "[`Product with the selected option combination is not available for purchase`]"}
{/if}
{if !empty($theme_settings.text_product_not_available_option_one_sku)}
    {$text_product_not_available_option_one_sku = $theme_settings.text_product_not_available_option_one_sku}
{else}
    {$text_product_not_available_option_one_sku = "[`This product is not available for purchase`]"}
{/if}
{$_is_dialog = $wa->get('cart')}

{$_is_dialog_select_options = $_is_dialog && $wa->get('select-options') && $theme_settings.product_addtocart_mini_dialog}
{$image_preview = $wa->shop->productImgUrl($product, '60')}
<!-- Спросить о настройке -->
{$add_order_action = $theme_settings.add_order_action}
{if $wa->isMobile()}{$add_order_action = $theme_settings.add_order_action_mobile}{/if}

{if $_is_dialog}<div class='js-modal-content modal-content modal-content--dialog{if $_is_dialog_select_options} modal-content--dialog-options{/if}'>{/if}

<form id="cart-form{if $_is_dialog}-dialog{/if}" class="js-add-to-cart add2cart {if $_is_dialog}product_action-dialog js-product js-product-page{/if}" method="post" action="{$wa->getUrl('/frontendCart/add')}" {if $add_order_action == 'popup'} data-image="{$image_preview}" data-name="{$product.name|escape}" data-price="{shop_currency_html($product.price)|escape}"{/if} data-after-action="{$add_order_action}" data-sku-url="{!$_is_dialog && !empty($theme_settings.product_sku_url)}">
    {if $_is_dialog && !$_is_dialog_select_options}
        {$product.features = $product->features}
        {$products = [$product.id => $product->data]}
        {$features =  $wa->shop->features($products)}
        {include file="product.gallery.html" inline}
        <div class="product_action-dialog-right">
            <a class="product_action-dialog-link" href="{$wa->shop->productUrl($product)}">[`Product page`]  &rarr;</a>
            <h1 class="product_name" itemprop="name">{$product.name|escape}</h1>
        {else if $_is_dialog_select_options}
                <h1 class="product_name" itemprop="name">{$product.name|escape}</h1>
        {/if}

    <div class="product_action" id="product-cart" data-id="{$product.id}">
        <!-- За что отвечает ? -->
        {if $_is_dialog || $_is_dialog_select_options}
            {function getDiscountCard price=null compare_price=null}
                {if $theme_settings.product_discount_percentage == 1}
                    {if $compare_price > $price}
                        {$discount = (($compare_price-$price)/$compare_price)*100}
                        {if $theme_settings.product_discount_percentage_round == "ceil"}
                            {$discount = ceil($discount)}
                        {else if $theme_settings.product_discount_percentage_round == "floor"}
                            {$discount = floor($discount)}
                        {else}
                            {$discount = round($discount)}
                        {/if}
                    {/if}
                    {$productDiscount = isset($discount) && $discount >= (int)$theme_settings.product_discount_percentage_minimal && $price > 0}
                    <div data-round="{$theme_settings.product_discount_percentage_round}" data-minimal="{$theme_settings.product_discount_percentage_minimal}" class="js-product-discount product-discount{if !$productDiscount} -Close{/if}">{if $productDiscount}-{$discount}%{/if}</div>
                {/if}
            {/function}

            {$_badge_saving = ($theme_settings.badge_saving == 1)}
            {$_badge_percent = ($theme_settings.product_discount_percentage == 1)}
            {if $_badge_saving || $_badge_percent}
                <div class="dialog_discounts">
                    {if $_badge_saving}
                        {$product_price_saving = 0}
                        {if $product.compare_price > $product.price  &&  $product.price != 0}
                            {$product_price_saving = $product.price - $product.compare_price}
                        {/if}
                        <span class="js-product-discounts product-price-saving{if empty($product_price_saving)} -Close{/if}">{shop_currency_html($product_price_saving)}</span>
                    {/if}
                    {getDiscountCard price=$product.price compare_price=$product.compare_price}
                </div>
            {/if}
        {/if}
        {if $product.sku_type}
            {if $theme_settings.product_show_multi_sku}
                {foreach $product.skus as $sku}
                    <span class="js-pd-code pd-code sku-{$sku.id}-pd-code" {if $sku.id != $product.sku_id}style="display:none"{/if}>
                        {if isset($sku.sku) && !empty($sku.sku)}<span class="hint">[`Vendor code`]:</span> {$sku.sku|escape} {else}<span class="hint">[`No sku`]</span>{/if}
                    </span>
                {/foreach}
            {/if}
            {$skuCode_feat_def = $product.sku_features}
            {$pd_available = $product.status}
            <div class="product_options options">
                {foreach $features_selectable as $f}
                    {if $theme_settings.product_type_options_select}
                        <div class="pd_option_select">
                            <div class="pd_option_select-title">
                                {$f.name}:
                            </div>
                            <select data-feature-id="{$f.id}" class="js-feature-sku feature-sku md" name="features[{$f.id}]">
                                {foreach $f.values as $v_id => $v}
                                <option value="{$v_id}" {if $v_id == ifset($skuCode_feat_def[$f.id])}selected{/if}>{$v}</option>
                                {/foreach}
                            </select>
                        </div>
                    {else}
                        <div class="select-v-inline{if $f.type == 'color'} color{/if}">
                            <div class="select-v-inline_title">{$f.name}:</div>
                            {foreach $f.values as $v_id => $v}
                                {if !isset($skuCode_feat_def[$f.id])}{$skuCode_feat_def[$f.id]=$v_id}{/if}
                                {if $f.type == 'color'}
                                    <div class="option-color_outer option-color_outer--card{if empty($theme_settings.is_product_option_color_text)} _without-text{/if}">
                                        <a data-value="{$v_id}" href="#"{if $v_id == ifset($skuCode_feat_def[$f.id])} class="selected"{/if} style="{$v->style};">
                                            <i class="fa fa-check color_checkmark"></i>
                                        </a>
                                        <span class="option-color_text">{$v|strip_tags|trim}</span>
                                    </div>
                                {else}
                                    <a data-value="{$v_id}" href="#"{if $v_id == ifset($skuCode_feat_def[$f.id])} class="selected"{/if}>{$v}</a>
                                {/if}
                            {/foreach}
                            <input type="hidden" data-feature-id="{$f.id}" class="js-feature-sku feature-sku" name="features[{$f.id}]" value="{ifset($skuCode_feat_def[$f.id])}">
                        </div>
                    {/if}
                {/foreach}
            </div>


            <div itemprop="offers" itemscope itemtype="http://schema.org/AggregateOffer">
                <meta itemprop="lowPrice" content="{shop_currency_html($product.min_price, null, null, false)}">
                <meta itemprop="highPrice" content="{shop_currency_html($product.max_price, null, null, false)}">
                <meta itemprop="priceCurrency" content="{$wa->shop->currency()}">
                <meta itemprop="offerCount" content="{$product.sku_count}">
                {foreach $product.skus as $sku}
                    <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
                        {$sku_available =  $product.status && $sku.available && ($wa->shop->settings('ignore_stock_count') || $sku.count === null || $sku.count > 0)}
                        {if $sku.name}<meta itemprop="name" content="{$sku.name|escape}">{/if}
                        {if $sku.sku}<meta itemprop="sku" content="{$sku.sku|escape}">{/if}
                        <meta itemprop="price" content="{$sku.price}">
                        <meta itemprop="priceCurrency" content="{$product.currency}">
                        {if (!($sku.count === null) && $sku.count <= 0)}
                            <link itemprop="availability" href="http://schema.org/OutOfStock" />
                        {else}
                            <link itemprop="availability" href="http://schema.org/InStock" />
                        {/if}
                    </div>
                {/foreach}
            </div>
        {else}
            {if count($product.skus) == 1}
                {$pd_one_option = $product.skus[$product.sku_id]}
                {if $pd_one_option.sku}<div class="pd-code"><span class="hint">[`Vendor code`]:</span> <span itemprop="sku">{$pd_one_option.sku|escape}</span></div>{/if}
            {/if}

            <div itemprop="offers" itemscope itemtype="http://schema.org/AggregateOffer">
                <meta itemprop="lowPrice" content="{shop_currency_html($product.min_price, null, null, false)}">
                <meta itemprop="highPrice" content="{shop_currency_html($product.max_price, null, null, false)}">
                <meta itemprop="priceCurrency" content="{$wa->shop->currency()}">
                <meta itemprop="offerCount" content="{$product.sku_count}">
                {$pd_available = false}
                {if count($product.skus) > 1}
                    {if $theme_settings.product_show_multi_radio_sku_separately}
                        {foreach $product.skus as $sku}
                            <span class="js-pd-code pd-code sku-{$sku.id}-pd-code" {if $sku.id != $product.sku_id}style="display:none"{/if}>
                                {if isset($sku.sku) && !empty($sku.sku)}<span class="hint">[`Vendor code`]:</span> {$sku.sku|escape}{else}<span class="hint">[`No sku`]</span>{/if}
                            </span>
                        {/foreach}
                    {/if}


                    {if $theme_settings.product_select_skus}
                        <div class="skus">
                            {foreach $product.skus as $sku}
                                {$sku_available =  $product.status && $sku.available && ($wa->shop->settings('ignore_stock_count') || $sku.count === null || $sku.count > 0)}
                                {if $sku_available || empty($theme_settings.hide_option_not_available)}
                                    <meta itemprop="price" content="{$sku.price}"/>
                                    <meta itemprop="priceCurrency" content="{$product.currency}"/>
                                    <meta itemprop="name" content="{$sku.name|escape}"/>
                                    {if $sku.sku}<meta itemprop="sku" content="{$sku.sku|escape}">{/if}
                                    {if (!($sku.count === null) && $sku.count <= 0)}
                                        <link itemprop="availability" href="http://schema.org/OutOfStock" />
                                    {else}
                                        <link itemprop="availability" href="http://schema.org/InStock" />
                                    {/if}
                                {/if}
                            {/foreach}
                            <select class="md" name="sku_id">
                                {foreach $product.skus as $sku}
                                    {$sku_available =  $product.status && $sku.available && ($wa->shop->settings('ignore_stock_count') || $sku.count === null || $sku.count > 0)}
                                    {if $sku_available || empty($theme_settings.hide_option_not_available)}
                                        <option{if !$sku.available} disabled="true"{/if}{if !$sku_available} data-disabled="1"{/if}{if $sku.id == $product.sku_id} selected="selected"{/if} value="{$sku.id}" data-compare-price="{shop_currency($sku.compare_price, $product.currency, null, 0)}" data-price="{shop_currency($sku.price, $product.currency, null, 0)}"{if $sku.image_id} data-image-id="{$sku.image_id}"{/if}>
                                            {$sku.name|escape} {if $sku.sku && empty($theme_settings.product_show_multi_radio_sku_separately)}- {$sku.sku|escape}{/if} ({shop_currency($sku.price, $product.currency)})
                                        </option>
                                    {/if}
                                {/foreach}
                            </select>
                        </div>
                    {else}
                        <ul class="skus js-product-skus">
                            {$max_count_skus = (int) $theme_settings.many_skus_count_max}
                            {$skus_index = 0}
                            {foreach $product.skus as $sku}
                                {$sku_available =  $product.status && $sku.available && ($wa->shop->settings('ignore_stock_count') || $sku.count === null || $sku.count > 0)}
                                {if $sku_available || empty($theme_settings.hide_option_not_available)}
                                    <li {if $max_count_skus && $skus_index >= $max_count_skus}class="js-product-skus-item hide" {/if}itemprop="offers" itemscope itemtype="http://schema.org/Offer">
                                        <label{if !$sku_available} class="disabled"{/if}>
                                            <meta itemprop="price" content="{$sku.price}">
                                            <meta itemprop="priceCurrency" content="{$product.currency}">
                                            <span class="js-toggle-styler radio-styler{if $sku.id == $product.sku_id} checked{/if}{if !$sku_available} disabled{/if}">
                                                <input class="js-toggle-styler-input" name="sku_id" type="radio" value="{$sku.id}"{if !$sku_available} disabled="disabled" data-disabled="1"{/if}{if $sku.id == $product.sku_id} checked="checked"{/if} data-compare-price="{shop_currency($sku.compare_price, $product.currency, null, 0)}" data-price="{shop_currency($sku.price, $product.currency, null, 0)}"{if $sku.image_id} data-image-id="{$sku.image_id}"{/if}>
                                            </span>
                                            <span itemprop="name">{$sku.name|escape}</span>
                                            {if $sku.sku && empty($theme_settings.product_show_multi_radio_sku_separately)}<span itemprop="sku" class="hint">{$sku.sku|escape}</span>{/if}
                                            <span class="price nowrap">{shop_currency_html($sku.price, $product.currency)}</span>
                                            {if (!($sku.count === null) && $sku.count <= 0)}
                                                <link itemprop="availability" href="http://schema.org/OutOfStock" />
                                            {else}
                                                <link itemprop="availability" href="http://schema.org/InStock" />
                                            {/if}
                                        </label>
                                    </li>
                                    {$skus_index = $skus_index + 1}
                                {/if}
                                {$pd_available = $pd_available or $sku_available}
                            {/foreach}
                            {if $max_count_skus && $skus_index > $max_count_skus}
                                <li>
                                    <span class="open-all-btn sdColor js-product-skus-show">
                                        <i class="fa fa-plus icon js-icon-plus" aria-hidden="true"></i>
                                        <i class="fa fa-minus icon js-icon-minus hide" aria-hidden="true"></i>
                                        <span class="link-half link-half--act">[`Show all`]</span>
                                    </span>
                                </li>
                            {/if}
                        </ul>
                    {/if}
                {else}

                    <div itemprop="offers" itemscope itemtype="http://schema.org/Offer">
                        {$sku = $product.skus[$product.sku_id]}
                        {if $sku.name}<meta itemprop="name" content="{$sku.name|escape}">{/if}
                        <meta itemprop="price" content="{$sku.price}">
                        <meta itemprop="priceCurrency" content="{$product.currency}">
                        {if !$sku.available}
                        <link itemprop="availability" href="http://schema.org/Discontinued" />
                        <p><em class="bold error">{$text_product_not_available_option_one_sku}</em></p>
                        {elseif !$wa->shop->settings('ignore_stock_count') && !($sku.count === null || $sku.count > 0)}
                        <link itemprop="availability" href="http://schema.org/OutOfStock" />
                        <div class="stocks"><span class="Product-stock-out">{if $wa->shop->settings('ignore_stock_count')}{$text_product_preorder}{else}{$text_not_avalible}{/if}</span></div>
                        {else}
                        <link itemprop="availability" href="http://schema.org/InStock" />
                        {/if}
                        <input name="sku_id" type="hidden" value="{$product.sku_id}">
                        {$pd_available = $product.status && $sku.available && ($wa->shop->settings('ignore_stock_count') || $sku.count === null || $sku.count > 0)}
                    </div>
                {/if}
            </div>
        {/if}

        <div class="box-hlighted product_add-services">
            {if $services}

                <div class="services">
                    {foreach $services as $s}
                    <div class="service-{$s.id} service__item">
                        <label>
                            <span class="js-style-check style-check{if !$pd_available} disabled{/if}">
                                <input class="js-style-check-input" data-price="{shop_currency($s.price, $s.currency, null, 0)}" {if !$pd_available}disabled="disabled"{/if} type="checkbox" name="services[]" value="{$s.id}">
                            </span>
                            {$s.name|escape} {if $s.price && !isset($s.variants)}+<span class="service-price">{shop_currency_html($s.price, $s.currency)}</span>{/if}
                        </label>
                        {if isset($s.variants)}
                            <select data-variant-id="{$s.variant_id}" class="service-choice" name="service-choice[{$s.id}]" disabled>
                                {foreach $s.variants as $v}
                                    <option {if $s.variant_id == $v.id}selected{/if} data-price="{shop_currency($v.price, $s.currency, null, 0)}" value="{$v.id}">{$v.name|escape} (+{shop_currency($v.price, $s.currency)})</option>
                                {/foreach}
                            </select>
                        {else}
                        <input type="hidden" name="service-choice[{$s.id}]" value="{$s.variant_id}">
                        {/if}
                    </div>
                    {/foreach}
                </div>
            {/if}

            <div class="js-add2cart product_add2cart">
                <div class="product_prices">
                    {$text_zero_price = $theme_settings.text_zero_price}
                    <span{if !empty($text_zero_price)} data-zero-text="{$text_zero_price}"{/if} data-price="{shop_currency($product.price, null, null, 0)}" class="product__price price nowrap">
                        {if !empty($text_zero_price) && $product.price == 0}
                            <span class="product_nul-price">{$text_zero_price}</span>
                        {else}
                            {shop_currency_html($product.price)}
                        {/if}
                    </span>

                    {if $product.compare_price > 0 && $product.price > 0}
                        <span class="js-compare-at-price product__old-price old-price nowrap">
                            {shop_currency_html($product.compare_price)}
                        </span>
                    {/if}
                </div>
                <input type="hidden" name="product_id" value="{$product.id}">
                <span class="js-qty Cart__Qty" >
                    <span data-type="-" class="js-qty-button Cart__Qty_act sdColor">-</span>
                    <input type="text" name="quantity" value="1" class="js-number">
                    <span data-type="+" class="js-qty-button Cart__Qty_act sdColor">+</span>
                </span>
                {$_hide_btn = $product.price == 0 && !empty($theme_settings.disabled_button_cart_zero_price)}
                <span class="button js-submit-form addtocart fi-rr-shopping-cart addtocart--large{if !$pd_available || $_hide_btn} disabled{/if}"{if !empty($theme_settings.disabled_button_cart_zero_price)} data-zero-price-disabled="1"{/if}>
                    {if $wa->shop->cart->total() > 0}[`Add to cart`]{else}[`Buy now`]{/if}
                </span>
            </div>

            {$_buy1click = class_exists('shopBuy1clickViewHelper') && $theme_settings.fastorder == "buy1click"}

            {if $_buy1click}
                <div class="product__fastorder">{shopBuy1clickViewHelper::getButton($product.id, $product.sku_id)}</div>
            {/if}

            <!-- plugin hook: 'frontend_product.cart' -->
            {* @event frontend_product.%plugin_id%.cart *}
            {foreach $frontend_product as $_}
            <div class="cart_plugin">{$_.cart}</div>
            {/foreach}
        </div>

        <div class="dt-block">

            {if ($pd_available || count($product.skus) > 1) && $theme_settings.product_show_stock}
                <div class="stocks product_stocks ">
                    {function name=in_stock n=0 low=5 critical=2}
                        {if $n > $low or $n === null}
                            <strong class="stock-high Product-stock_item Product-stock_item-high">
                                <i class="fa fa-check icon" aria-hidden="true"></i>
                                [`In stock`]
                                {if $theme_settings.product_show_stock_count && $n !== null}
                                    : {$n} [`unit`]
                                {/if}
                            </strong>
                        {elseif $n > $critical}
                            <strong class="stock-low Product-stock_item Product-stock_item-low">
                                <i class="fa fa-check icon" aria-hidden="true"></i>
                                {if $theme_settings.product_show_stock_count}
                                    {_w("Only %d left in stock", "Only %d left in stock", $n)}
                                {else}
                                    {_w("Only a few items left")}
                                {/if}
                            </strong>
                        {elseif $n > 0}
                            <strong class="stock-critical Product-stock_item Product-stock_item-critical">
                                <i class="fa fa-exclamation icon" aria-hidden="true"></i>
                                {if $theme_settings.product_show_stock_count_critical}
                                    {_w("Only %d left in stock", "Only %d left in stock", $n)}
                                {else}
                                    {_w("Only a few items left")}
                                {/if}
                            </strong>
                        {else}
                            {if $wa->shop->settings('ignore_stock_count')}
                                <strong class="stock-none Product-stock_item Product-stock_item-critical">
                                    <i class="fa fa-exclamation icon" aria-hidden="true"></i>
                                    {$text_product_preorder}
                                </strong>
                            {else}
                                <strong class="stock-none Product-stock_item Product-stock_item-out">
                                    <i class="fa fa-times icon" aria-hidden="true"></i>
                                    {$text_not_avalible}
                                </strong>
                            {/if}
                        {/if}
                    {/function}
                    {foreach $product.skus as $sku}
                        <div {if $sku.id != $product.sku_id}style="display:none"{/if} class="sku-{$sku.id}-stock">
                            {if $sku.stock}
                            {foreach $stocks as $stock_id => $stock}
                            {if isset($sku.stock[$stock_id])}
                            {$stock_count = $sku.stock[$stock_id]}
                            {else}
                            {$stock_count = null}
                            {/if}
                            <span class="stocks_title">{$stock.name}:</span> {in_stock n=$stock_count low=$stock.low_count critical=$stock.critical_count}<br>
                            {/foreach}
                            {else}
                            {in_stock n=$sku.count}
                            {/if}
                        </div>
                    {/foreach}
                    {if $product.sku_type}
                        <div class="sku-no-stock">
                            <strong class="stock-none">{$text_product_not_available_option}</strong>
                        </div>
                    {/if}
                </div>
            {/if}
            {if $theme_settings.pd_share_script && !$_is_dialog_select_options}
                <div class="product_share">{$theme_settings.pd_share_script}</div>
            {/if}
        </div>
    </div>

    {if !$_is_dialog_select_options}{include file="product.short.description.html"}{/if}

    {if $_is_dialog && !$_is_dialog_select_options}
        </div>
    {/if}

    {if $wa->get('cart')}
        {$product.features = $product->features}
        {$products = [$product.id => $product->data]}
        {$features =  $wa->shop->features($products)}
    {/if}
    {$features_list = $features}
    {if !empty($sku_features)}{$features_list = $sku_features}{/if}

    {$skus_features = []}
    {if !empty($product.skus) && count($product.skus) > 1}
        {foreach $product.skus as $sku_id => $sku}
            {if !empty($sku.features)}
                {$temp_sku_features = []}
                {foreach $sku.features as $f_code => $f_value}
                    {capture assign="_sku_features_html"}
                        {if is_array($f_value)}
                            {if $features_list[$f_code].type == 'color'}
                                {implode('<br /> ', $f_value)}
                            {else}
                                {implode(', ', $f_value)}
                            {/if}
                        {else}
                            {$f_value}
                        {/if}
                    {/capture}
                    {$temp_sku_features[$f_code] = $_sku_features_html}
                {/foreach}
                {$skus_features[$sku_id] = $temp_sku_features}
            {/if}
        {/foreach}
    {/if}

    <script>
        $(function(){
            new Product('#cart-form{if $_is_dialog}-dialog{/if}', {
                    currency: {json_encode($currency_info)}
                {if count($product.skus) > 1 or $product.sku_type}
                    ,services: {json_encode($sku_services)}
                {/if}
                {if $product.sku_type}
                    ,features: {json_encode($sku_features_selectable)}
                {/if}
                {if !empty($sku_features) && count($skus_features) > 1}
                    ,sku_features: {json_encode($sku_features)}
                    ,skus_features: {json_encode($skus_features)}
                    ,short_features_count: "{$theme_settings.count_output_features_right_block}"
                    ,short_features_codes: "{$theme_settings.codes_features_list}"
                {/if}
            });
        });
    </script>
</form>

{if $_is_dialog}</div> <!-- .modal-content.modal-content--dialog -->{/if}

{/strip}