{strip}
{$cols = 1} {$sb_left = 0}
{if $theme_settings.product_sidebar_left && !$wa->isMobile()}
    {$cols = $cols + 1}
    {$sb_left = 1}
{/if}

{if $wa->isMobile()}
    {$product_alias_str = $theme_settings.product_page_main_description_mobile}
{else}
    {$product_alias_str = $theme_settings.product_page_main_description_desktop}
{/if}
{$_show_description = strpos($product_alias_str, 'description') !== false && $product.description}
{$_show_features =  strpos($product_alias_str, 'features') !== false && $product.features}

{function getDiscountCard price=null compare_price=null}
    {if $theme_settings.product_discount_percentage == 1}
        {if $compare_price > $price}
            {$discount = (($compare_price-$price)/$compare_price)*100}
            {if $theme_settings.product_discount_percentage_round == "ceil"}
                {$discount = ceil($discount)}
            {else if $theme_settings.product_discount_percentage_round == "floor"}
                {$discount = floor($discount)}
            {else}
                {$discount = round($discount)}
            {/if}
        {/if}
        {$productDiscount = isset($discount) && $discount >= (int)$theme_settings.product_discount_percentage_minimal && $price > 0}
        <div data-round="{$theme_settings.product_discount_percentage_round}" data-minimal="{$theme_settings.product_discount_percentage_minimal}" class="js-product-discount product-discount product-card__discount{if !$productDiscount} -Close{/if}">{if $productDiscount}-{$discount}%{/if}</div>
    {/if}
{/function}

<div class="cols-{$cols}">
    <div class="out_sidebars">
        {if $sb_left}
            {include file='sidebar-left.html'}
        {/if}
    </div>

    <div id="page-content" class="{if $sb_left} with-sidebar{/if}">
        <article class="js-product-page product_page" itemscope itemtype="http://schema.org/Product">
            <div class="content">
                <div class="content-box">
                    <div class="dt-block">
                        <h1 class="product_name" itemprop="name">{$product.name|escape}</h1>
                    </div>
                    <div class="dt-block">
                        {if $theme_settings.product_ratings}
                            {if $product.rating > 0}
                                <span class="product_rating rating nowrap" itemprop="aggregateRating" itemscope itemtype="http://schema.org/AggregateRating" title="{sprintf('[`Average user rating: %s / 5`]', $product.rating)}">
                                    {$wa->shop->ratingHtml($product.rating, 16)}
                                    <span itemprop="ratingValue" style="display: none;">{$product.rating}</span>
                                    <span itemprop="reviewCount" style="display: none;">{$reviews_total_count}</span>
                                </span>
                            {else}
                                <span class="product_rating rating nowrap">
                                    <i class="icon16 star-rating-empty"></i>
                                    <i class="icon16 star-rating-empty"></i>
                                    <i class="icon16 star-rating-empty"></i>
                                    <i class="icon16 star-rating-empty"></i>
                                    <i class="icon16 star-rating-empty"></i>
                                </span>
                            {/if}
                        {/if}

                        {$_badge_saving = $theme_settings.badge_saving == 1}
                        {$_badge_percent = $theme_settings.product_discount_percentage == 1}
                        {if $_badge_saving || $_badge_percent}
                            <div class="product-card_discounts">
                                {if $_badge_saving}
                                    {$product_price_saving = 0}
                                    {if $product.compare_price > $product.price  &&  $product.price != 0}
                                        {$product_price_saving = $product.price - $product.compare_price}
                                    {/if}
                                    <span class="js-product-discounts product-price-saving{if empty($product_price_saving)} -Close{/if}">{shop_currency_html($product_price_saving)}</span>
                                {/if}
                                {getDiscountCard price=$product.price compare_price=$product.compare_price}
                            </div>
                        {/if}

                        {if $theme_settings.favorites || $theme_settings.compare}
                            <div class="product_action-btn">
                                {if $theme_settings.favorites}
                                {$favorites = $wa->cookie('product_favor_arr')}
                                {if $favorites}
                                {$product_favor_arr = ","|explode:$favorites}
                                {else}
                                {$product_favor_arr = []}
                                {/if}
                                <span data-product="{$product.id}" class="js-favorites-add product-action add-to-favorite {if in_array($product.id, $product_favor_arr)} active{/if}">
                                    <i class="fi-rr-heart"></i>
                                    <span class="product-action-text">[`To favorites`]</span>
                                </span>
                                {/if}
                                {if $theme_settings.compare}
                                <span data-name="{$product.name|escape}" data-img="{$wa->shop->productImgUrl($product, '60')}" data-url="{$product.frontend_url}" data-product="{$product.id}" class="js-compare-add product-action add-to-compare {if $wa->shop->inComparison($product.id)} active{/if}">
                                    <i class="fa fa-files-o"></i>
                                    <span class="product-action-text">[`Compare`]</span>
                                </span>
                                {/if}
                            </div>
                        {/if}
                    </div>
                </div>

                <div class="product-page_main js-product">
                    {include file="product.gallery.html" inline}
                    <div class="product-page_main-right">
                            <div class="cart ">
                                {include file="product.cart.html" inline}
                            </div>

                            <!-- plugin hook: 'frontend_product.block_aux' -->
                            {* @event frontend_product.%plugin_id%.block_aux *}
                            {if !empty($frontend_product)}
                                <div class="cart_aux">
                                    {foreach $frontend_product as $_}{$_.block_aux}{/foreach}
                                </div>
                            {/if}

                            <!-- plugin hook: 'frontend_product.menu' -->
                            {* @event frontend_product.%plugin_id%.menu *}
                            {foreach $frontend_product as $_}{$_.menu}{/foreach}


                            {if $theme_settings.plugin_hook_block_in_product == 'right_block'}
                                <!-- plugin hook: 'frontend_product.block' -->
                                {* @event frontend_product.%plugin_id%.block *}
                                {foreach $frontend_product as $_}{$_.block}{/foreach}
                            {/if}
                    </div>
                </div>
            </div>

            {$list_product_alias_arr = []}
            {if !empty($product_alias_str)}{$list_product_alias_arr = ","|explode:$product_alias_str}{/if}

            {if $wa->isMobile()}
                {$view_tabs_type = $theme_settings.type_view_main_content_product_mobile}
            {else}
                {$view_tabs_type = $theme_settings.type_view_main_content_product_desktop}
            {/if}

            {$_tabs_normal = ($view_tabs_type == "normal_tabs")}
            {$_tabs_anchor = ($view_tabs_type == "anchor_tabs")}
            {$_tabs_none = ($view_tabs_type == "none_tabs")}
            {$_tabs_acc = $view_tabs_type == "acc_tabs"}

            {if $theme_settings.name_tab_features}{$name_tab_features = $theme_settings.name_tab_features}{else}{$name_tab_features = "[`Characteristics`]"}{/if}
            {if $theme_settings.name_tab_reviews}{$name_tab_reviews = $theme_settings.name_tab_reviews}{else}{$name_tab_reviews = "[`Reviews`]"}{/if}
            {if $theme_settings.name_tab_description}{$name_tab_description = $theme_settings.name_tab_description}{else}{$name_tab_description = "[`Overview`]"}{/if}
            <div class="content">
                {if ($_tabs_normal || $_tabs_anchor) && count($list_product_alias_arr) > 0}
                    <ul class="tabs js-tabs clear-list">
                        {foreach $list_product_alias_arr as $item_alias_content}
                            {if $item_alias_content == 'description' && $product.description}
                                <li class="{if $_tabs_normal}js-tab {/if}{if $_tabs_anchor}js-motion-to-tab {/if} tabs_item" data-tab-content="product-description">{$name_tab_description}</li>
                            {else if $item_alias_content == 'features' && $product.features}
                                <li class="{if $_tabs_normal}js-tab {/if}{if $_tabs_anchor}js-motion-to-tab {/if} tabs_item" data-tab-content="product-options">{$name_tab_features}</li>
                            {else if $item_alias_content == 'reviews'}
                                <li class="{if $_tabs_normal}js-tab {/if}{if $_tabs_anchor}js-motion-to-tab {/if} tabs_item" data-tab-content="product-reviews">{$name_tab_reviews} <span class="hint">({$reviews_total_count})</span></li>
                            {else if $item_alias_content == 'pages' && count($product.pages) > 0}
                                {foreach $product.pages as $page}
                                    <li class="{if $_tabs_normal}js-tab {/if}{if $_tabs_anchor}js-motion-to-tab {/if} tabs_item" data-tab-content="product-page-{$page.id}">{$page.name|escape}</li>
                                {/foreach}
                            {else if $item_alias_content == 'add' && $theme_settings.product_add_info_title}
                                <li class="{if $_tabs_normal}js-tab {/if}{if $_tabs_anchor}js-motion-to-tab {/if} tabs_item" data-tab-content="product-page-addinfo">{$theme_settings.product_add_info_title|escape}</li>
                            {/if}
                        {/foreach}
                    </ul>
                {/if}

                {$class_product_wrap_content = "product-wrap-content"}
                {$class_product_content = "product-content__el"}
                {if $_tabs_normal}
                    {$class_product_wrap_content = "tab-contents js-tabs-wrap"}
                    {$class_product_content = "js-tab-content tab-content_el"}
                {/if}
                {if $_tabs_acc}
                    {$class_product_wrap_content = "tab-acc-wrap js-tabs-acc-wrap"}
                    {$class_product_content = "js-acc-tab-content acc-tab-content_item"}
                {/if}

                
                {if count($list_product_alias_arr) > 0}
                    <div class="{$class_product_wrap_content}">
                        {foreach $list_product_alias_arr as $item_alias_content}
                            {if $item_alias_content == 'description' && $product.description}
                                {if $_tabs_acc}
                                    <div class="js-acc-tab acc-tabs-el" data-tab-content="product-description">
                                        <span class="acc-tabs-caret">
                                            <span class="acc-tabs-caret__icon maincolor"></span>
                                        </span>
                                        <div class="acc-tabs-title">{$name_tab_description}</div>
                                    </div>
                                {/if}
                                <div id="product-description" class="product_description {$class_product_content}">
                                    {if !$_tabs_normal && !$_tabs_acc}
                                        <div class="product-tab_title"><h2>{$name_tab_description}</h2></div>
                                    {/if}
                                    {if $theme_settings.product_page_show_brand_content && $theme_settings.use_plugin_brands == 'brands_pro' && class_exists('shopBrandViewHelper')}
                                        {$_brand_pro = shopBrandViewHelper::getProductBrand($product)}
                                        {if !empty($_brand_pro) && $_brand_pro.image_url}
                                            <div class="product_desc-brand">
                                                <a class="brand_product-img" href="{$_brand_pro.frontend_url}"><img alt="{$_brand_pro.name|escape}" src="{$_brand_pro.image_url}"></a>
                                            </div>
                                        {/if}
                                    {else if $theme_settings.product_page_show_brand_content && $theme_settings.use_plugin_brands == 'brands' && class_exists('shopProductbrandsPlugin')}
                                        {$_b = shopProductbrandsPlugin::productBrand($product.id)}
                                        {if !empty($_b) && $_b.image}
                                            <div class="product_desc-brand">
                                                <a class="brand_product-img" href="{$_b.url}"><img alt="{$_b.name|escape}" src="{$wa_url}wa-data/public/shop/brands/{$_b.id}/{$_b.id}.200{$_b.image}"></a>
                                            </div>
                                        {/if}
                                    {/if}
                                    <div itemprop="description">{$product.description}</div>
                                </div>
                            {else if $item_alias_content == 'features' && $product.features}
                                {if $_tabs_acc}
                                    <div class="js-acc-tab acc-tabs-el" data-tab-content="product-options">
                                        <span class="acc-tabs-caret">
                                            <span class="acc-tabs-caret__icon maincolor"></span>
                                        </span>
                                        <div class="acc-tabs-title">{$name_tab_features}</div>
                                    </div>
                                {/if}
                                <div id="product-options" class="product_options {$class_product_content}">
                                    {if !$_tabs_normal && !$_tabs_acc}
                                        <div class="product-tab_title"><h2>{$name_tab_features}</h2></div>
                                    {/if}
                                    <table class="js-product-features Product__features">

                                        {if !empty($sku_features)}
                                            {$features_items = $sku_features}
                                        {else}
                                            {$features_items = $features}
                                        {/if}

                                        {if !empty($product.skus[$product.sku_id].features)}
                                            {$product_features_items = $product.skus[$product.sku_id].features}
                                        {else}
                                            {$product_features_items = $product.features}
                                        {/if}

                                        {if class_exists('shopGroupattrPlugin')}
                                            {$product_features_items = shopGroupattrPlugin::process($product, $features_items)}
                                        {/if}
                                        {if class_exists('shopSeofilterViewHelper')}
                                            {$product_features_items = shopSeofilterViewHelper::wrapFeatureValues($product_features_items)}
                                        {/if}
                                        {foreach $product_features_items as $f_code => $f_value}
                                            {if !empty($features_items[$f_code])}
                                                <tr class="Product__features-item {if $features_items[$f_code].type == 'divider'} divider{/if}">
                                                    <td class="Product__features-title">
                                                        <span>{$features_items[$f_code].name|escape}</span>
                                                    </td>
                                                    {$_good_param = ($f_code|in_array:["weight", "model", "width", "height", "depth", "color", "manufacturer"])}
                                                    {$itemProp = ""}
                                                    {if $_good_param}
                                                        {$itemProp = $f_code}
                                                    {/if}
                                                    {if $theme_settings.brand_id && $theme_settings.brand_id == $f_code}
                                                        {$itemProp = "brand"}
                                                    {/if}
                                                    <td class="Product__features-value"{if $itemProp} itemprop="{$itemProp}"{/if}>
                                                        {if $features_items[$f_code].type != 'divider'}
                                                            {if is_array($f_value)}
                                                                {if $features_items[$f_code].type == 'color'}
                                                                    {implode('<br /> ', $f_value)}
                                                                {else}
                                                                    {implode(', ', $f_value)}
                                                                {/if}
                                                            {else}
                                                                {$f_value}
                                                            {/if}
                                                        {/if}
                                                    </td>
                                                </tr>
                                            {/if}
                                        {/foreach}
                                    </table>
                                </div>
                            {else if $item_alias_content == 'reviews'}
                                {if $_tabs_acc}
                                    <div class="js-acc-tab acc-tabs-el" data-tab-content="product-reviews">
                                        <span class="acc-tabs-caret">
                                            <span class="acc-tabs-caret__icon maincolor"></span>
                                        </span>
                                        <div class="acc-tabs-title">{$name_tab_reviews} <span class="product-reviews__count maincolor">{$reviews_total_count}</span></div>
                                    </div>
                                {/if}
                                <section id="product-reviews" class="product_reviews {$class_product_content}">
                                    <h2>{sprintf('[`%s reviews`]', $product.name|escape)}</h2>

                                    {if !empty($rates)}
                                        <p class="rating">
                                            [`Average customer rating:`]
                                            <span class="nowrap">{$wa->shop->ratingHtml($product.rating, 16)}</span> (<a href="reviews/">{$reviews_total_count}</a>)
                                            {if $product.rating > 0}<span class="hint product_rating-total">{sprintf('[`%s out of 5 stars`]', $product.rating)}</span>{/if}
                                        </p>

                                        <table class="rating-result">
                                            {$_total_count = 0}

                                            {foreach $rates as $_rate => $_count}
                                                {$_total_count = $_total_count + $_count}
                                            {/foreach}

                                            {for $i = 5 to 0 step -1}
                                                {if empty($rates[$i]) || !$rates[$i]}{$_count = 0}{else}{$_count = $rates[$i]}{/if}
                                                {if $i || $_count}
                                                    <tr>
                                                        <td class="min-width hint">{$_count}</td>
                                                        <td>
                                                            <div class="bar">
                                                                <div class="filling bg-sdColor" style="width: {if $_total_count > 0}{str_replace(',','.', 100*$_count/$_total_count)}{else}0{/if}%;{if !$i} background: #ddd;{/if}"></div>
                                                            </div>
                                                        </td>
                                                        <td>
                                                            <span class="rating">{for $j=1 to $i}<i class="icon10 star"></i>{forelse}<span class="hint">[`no rate`]</span>{/for}</span>
                                                        </td>
                                                    </tr>
                                                {/if}
                                            {/for}
                                        </table>
                                    {/if}
                                    <div class="js-reviews-content" data-url-product="{$wa->shop->productUrl($product)}">
                                        {if $reviews}
                                            {foreach $reviews as $review}
                                                {include file="review.html" _schema_org=true inline}
                                            {/foreach}
                                        {else}
                                            Отзывов нет
                                        {/if}
                                    </div>
                                </section>
                            {else if $item_alias_content == 'pages' && count($product.pages) > 0}
                                {foreach $product.pages as $page}
                                    {if $_tabs_acc}
                                        <div class="js-acc-tab acc-tabs-el" data-tab-content="product-page-{$page.id}">
                                            <span class="acc-tabs-caret">
                                                <span class="acc-tabs-caret__icon maincolor"></span>
                                            </span>
                                            <div class="acc-tabs-title">{$page.name|escape}</div>
                                        </div>
                                    {/if}
                                    <div id="product-page-{$page.id}" class="product_page {$class_product_content}">
                                        {if !$_tabs_normal && !$_tabs_acc}
                                            <div class="product-tab_title"><h2>{$page.name|escape}</h2></div>
                                        {/if}
                                        {eval var=$page.content}
                                    </div>
                                {/foreach}
                            {/if}
                        {/foreach}
                    </div>
                {/if}

                {if $theme_settings.plugin_hook_block_in_product != 'right_block'}
                    {* @event frontend_product.%plugin_id%.block *}
                    {foreach $frontend_product as $_}
                        {$_.block}
                    {/foreach}
                {/if }
                {if $theme_settings.show_tags_pr_page && $product.tags}
                    <div class="product_tags-cats">
                        <!-- tags -->
                        {if $theme_settings.show_tags_pr_page && $product.tags}
                            <div class="product_tags">
                                [`Tags`]:

                                <span class="tags cloud maincolor">
                                    {if class_exists('shopTageditorPlugin')}
                                         {foreach shopTageditorPlugin::tags($product.tags) as $t}
                                            <a href="{$wa->getUrl('/frontend/tag', ['tag' => $t.uri_name])}">{$t.name|escape}</a>
                                         {/foreach}
                                    {else}
                                       {foreach $product.tags as $t}
                                            <a href="{$wa->getUrl('/frontend/tag', ['tag' => urlencode($t)])}">{$t}</a>
                                        {/foreach}
                                    {/if}
                                </span>
                            </div>
                        {/if}
                    </div>
                {/if}
            </div>
        </article>

        {if empty($totalCrossselling)}{$totalCrossselling = 10}{else}{$totalCrossselling = (int) $theme_settings.total_crossselling}{/if}
        {$crossselling = $product->crossSelling($totalCrossselling)}


        {if empty($count_upselling)}{$count_upselling = 10}{else}{$count_upselling = (int) $theme_settings.upselling_count}{/if}
        {$upselling = $product->upSelling($count_upselling)}

        {$viewed_product_list = $wa->cookie('viewed_product_list')}

        {if isset($theme_settings.pr_list_view_type) && !empty($theme_settings.pr_list_view_type)}
            {$products_view = $theme_settings.pr_list_view_type}
        {/if}

        {if $crossselling || $upselling || ( $theme_settings.show_list_viewed_products && $theme_settings.product_page_views_products && $viewed_product_list)}
            <div class="content product_cross-products">
                {if $crossselling}
                    {$product_list_title = sprintf('C "%s" так же берут', $product.name|escape)}
                    {if $products_view == "tile-carousel" && !$wa->isMobile()}
                        {include file="product.products-carousel.html" products=$crossselling product_list_title=$product_list_title}
                    {else}
                        {include file="product.products-list.html" products=$crossselling product_list_title=$product_list_title CategoryViewProducts=$products_view}
                    {/if}
                {/if}

                {if $upselling}
                    {$compare_ids = array_merge(array($product.id), array_keys($upselling))}
                    {$onClick = "javascript:window.location='{$wa->getUrl('/frontend/compare', ['id' => implode(',', $compare_ids)])}';"}
                    {$product_list_title = "[`See also`] <a class='product_cross-compare sdColor link-half' onClick=`$onClick`>[`Compare all`]</a>"}
                    {if $products_view == "tile-carousel" && !$wa->isMobile()}
                        {include file="product.products-carousel.html" products=$upselling product_list_title=$product_list_title}
                    {else}
                        {include file="product.products-list.html" products=$upselling product_list_title=$product_list_title CategoryViewProducts=$products_view}
                    {/if}
                {/if}

                {if $theme_settings.show_list_viewed_products && $viewed_product_list && ($theme_settings.product_page_views_products || $wa->isMobile())}
                    {$viewed_product_list_arr = ","|explode:$viewed_product_list}
                    {$viewed_product_list_arr_lasted = []}
                    {$counter = 1}
                    {foreach $viewed_product_list_arr as $id}
                        {$viewed_product_list_arr_lasted[] = $id}
                        {if $counter++ == 10}
                            {break}
                        {/if}
                    {/foreach}
                    {$products = $wa->shop->products($viewed_product_list_arr_lasted)}
                    {$products_result = []}
                    {foreach $viewed_product_list_arr as $id}
                        {foreach $products as $product}
                            {if $product.id == $id}
                                {$products_result[$id] = $product}
                            {/if}
                        {/foreach}
                    {/foreach}
                    {if $products_view == "tile-carousel" && !$wa->isMobile()}
                        {include file="product.products-carousel.html" products=$products_result product_list_title="[`Viewed products`]"}
                    {else}
                        {include file="product.products-list.html" products=$products_result product_list_title="[`Viewed products`]" CategoryViewProducts=$products_view}
                    {/if}
                {/if}
            </div>
        {/if}
    </div>
</div>

<script>
    ( function($) {
        var reviewsSection = $('#product-reviews');

        function loadProductCardReviews (){
            var reviewsContent = $('.js-reviews-content'),
                isLoad = reviewsContent.find('.js-reviews-wrap').length;

            if(!isLoad){
                reviewsContent.html("");
                reviewsContent.append('<div><br><img alt="Loading..." src="{$wa_parent_theme_url}img/loading16.gif"></div>');

                var url = reviewsContent.data("url-product").replace(/\/#\/[^#]*|\/#|\/$/g, '') + '/reviews/';

                $.get(url, function(data) {
                    var content = $(data).find('.js-reviews-wrap');
                    reviewsContent.html(content);
                });
            }
        }

        if(reviewsSection.length && reviewsSection.is(':visible') || reviewsSection.is(':first-child') || $('.js-acc-tab:first-child + #product-reviews').length){
            loadProductCardReviews();
        }else{
            $('.js-tab[data-tab-content="product-reviews"], .js-acc-tab[data-tab-content="product-reviews"]').one("click", function (){
                loadProductCardReviews();
            });
        }
    })(jQuery);
</script>


{/strip}


