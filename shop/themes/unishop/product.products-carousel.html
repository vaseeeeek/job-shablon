{strip}
{if !empty($products)}
    {$favorites = $wa->cookie('product_favor_arr')}
    {if $favorites}
        {$product_favor_arr = ","|explode:$favorites}
    {else}
        {$product_favor_arr = []}
    {/if}
    {if (!$wa->isMobile() && !empty($theme_settings.product_show_tile_features)) || ($wa->isMobile() && !empty($theme_settings.product_show_tile_mobile_features))}
        {$features = $wa->shop->features($products)}
    {/if}

    {$isPreviewProductGalleryTile = $theme_settings.product_scroll_hover_gallery}
    {if $isPreviewProductGalleryTile}
        {$products_ids = ""}
        {foreach $products as $p}
            {if $p.id}{$products_ids[] = $p.id}{/if}
        {/foreach}
        {$size_image = '0x260'}
        {$products_images = $wa->shop->images($products_ids, $size_image)}
    {/if}
    <script>
        let imgObjProducts = new Object();
    </script>
    <section class="js-owl-carousel-product product_cross__carousel">
        <div class="product_cross-title__outer">
            <h3 class="product_cross-title">{$product_list_title}</h3>
        </div>
        <div class="products-grid-outer">
            <div data-retina="{$wa->shop->config('enable_2x')}" class="js-preview-products products-tile">
                <div class="owl-carousel owl-theme"{if $is_preview_grid_mini} data-type-mobile-preview="mini"{/if}>
                    {foreach $products as $p}
                        {include file="product-preview-tile.html" product=$p favorites=$product_favor_arr lazy_class="owl-lazy" isOwlSlider='true'}
                    {/foreach}
                </div>
                <div class="product_cross__direction js-carousel-direction"></div>
            </div>
        </div>
    </section>
{/if}
{/strip}
{if !$wa->isMobile()}
    <style>
        .grid-gallery__list {
            position: absolute;
            width: 100%;
            height: 100%;
            left: 0;
            top: 0;
            display: -ms-flexbox;
            display: flex;
        }
        span.grid-gallery__el.js-grid-gallery-item {
            z-index: 2;
        }
        ._tile-active .grid-gallery__el {
            position: relative;
        }
    </style>
    <script>
        $(function () {
            $(".grid-gallery__el").hover(function() {
                let _this = $(this);
                let id = _this.attr('data-id');
                console.log(id);
                let wrap = _this.closest('.Product-grid');
                wrap.find('.dotted-img__item').each(function() {
                    if ($(this).attr('data-id') == id) {
                        $(this).addClass('-Active');
                    } else {
                        $(this).removeClass('-Active');
                    }
                });
            });
            $('.Product-grid_img').mouseout(function() {
                $('.dotted-img__item').each(function() {
                    if ($(this).attr('data-id') == 1) {
                        $(this).addClass('-Active');
                    } else {
                        $(this).removeClass('-Active');
                    }
                });
            })
        })
    </script>
{else}
    <script>
        var startCoords = {},
            endCoords = {};
        let productId = '';
        let product = '';
        $('.Product-grid_img').bind("touchstart", function(event) {
            startCoords = endCoords = event.originalEvent.targetTouches[0];
            product = $(this).closest('.Product-grid');
            productId = $(this).closest('.Product-grid').attr("data-product-num");
        });
        $('.Product-grid_img').bind("touchmove", function(event) {
            endCoords = event.originalEvent.targetTouches[0];
        });
        {literal}
        $('.Product-grid_img').bind("touchend", function() {
            let mobileProductWrapDotted = product.find('.dotted-img__item');
            let startSrc = $(this).find('.js-product-preview-img').attr("src");
            imgObjProducts[productId].forEach((element, index) => {
                if (startSrc == element) {
                    startSrcIndex = index;
                    if (startCoords.clientX < endCoords.clientX){ // назад
                        endSrcIndex = startSrcIndex - 1;
                        $(this).find('.js-product-preview-img').attr("src", imgObjProducts[productId][endSrcIndex]);
                        mobileProductWrapDotted.each(function() {
                            if (endSrcIndex >= 0) {
                                if ($(this).attr('data-id') == endSrcIndex + 1) {
                                    $(this).addClass('-Active');
                                } else {
                                    $(this).removeClass('-Active');
                                }
                            }
                        });
                    }
                    if (startCoords.clientX > endCoords.clientX){ // след
                        endSrcIndex = startSrcIndex + 1;
                        $(this).find('.js-product-preview-img').attr("src", imgObjProducts[productId][endSrcIndex]);
                        mobileProductWrapDotted.each(function() {
                            if (endSrcIndex < mobileProductWrapDotted.length) {
                                if ($(this).attr('data-id') == endSrcIndex + 1) {
                                    $(this).addClass('-Active');
                                } else {
                                    $(this).removeClass('-Active');
                                }
                            }
                        });
                    }
                }
            })
        });
        {/literal}
    </script>
{/if}
